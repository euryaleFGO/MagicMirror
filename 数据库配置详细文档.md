# MagicMirror 数据库配置详细文档

## 一、数据库连接配置

### 1.1 基本信息

| 配置项 | 值 | 说明 |
|--------|-----|------|
| **数据库类型** | MySQL | 关系型数据库管理系统 |
| **主机地址** | localhost | 数据库服务器地址 |
| **端口** | 3306 | MySQL 默认端口 |
| **用户名** | root | 数据库连接用户名 |
| **数据库名** | magicmirror | 项目使用的数据库名称 |
| **字符集** | utf8mb4 | 支持完整 Unicode 字符集（包括 emoji） |

### 1.2 配置文件位置

- **配置文件**: `backend/config.py`
- **环境变量文件**: `backend/.env` 
- **初始化脚本**: `backend/init_database.py`

### 1.3 连接方式

项目使用 `pymysql` 库进行数据库连接，连接配置从环境变量或默认值读取：

```python
MYSQL_HOST = os.getenv('MYSQL_HOST', 'localhost')
MYSQL_PORT = int(os.getenv('MYSQL_PORT', 3306))
MYSQL_USER = os.getenv('MYSQL_USER', 'root')
MYSQL_PASSWORD = os.getenv('MYSQL_PASSWORD', '')
MYSQL_DATABASE = os.getenv('MYSQL_DATABASE', 'magicmirror')
MYSQL_CHARSET = os.getenv('MYSQL_CHARSET', 'utf8mb4')
```

---

## 二、数据库表结构

数据库共包含 **5 个表**，用于管理用户、对话、消息和说话人信息。

### 2.1 users（用户表）

**用途**: 存储系统用户的基本信息

| 字段名 | 类型 | 允许NULL | 键 | 默认值 | 说明 |
|--------|------|----------|-----|--------|------|
| id | INT | NO | PRI, AUTO_INCREMENT | NULL | 用户ID（主键） |
| username | VARCHAR(100) | NO | UNI | NULL | 用户名（唯一） |
| password | VARCHAR(255) | NO | - | NULL | 加密后的密码 |
| created_at | TIMESTAMP | YES | - | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY (id)
- UNIQUE KEY (username)

**当前记录数**: 2

---

### 2.2 conversations（对话会话表）

**用途**: 存储用户与AI的对话会话信息，每个会话包含多条消息

| 字段名 | 类型 | 允许NULL | 键 | 默认值 | 说明 |
|--------|------|----------|-----|--------|------|
| id | INT | NO | PRI, AUTO_INCREMENT | NULL | 对话ID（主键） |
| user_id | INT | NO | MUL, FK | NULL | 用户ID（外键关联users.id） |
| title | VARCHAR(255) | YES | - | NULL | 对话标题（自动生成） |
| created_at | TIMESTAMP | YES | - | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | YES | MUL | CURRENT_TIMESTAMP | 更新时间（自动更新） |

**索引**:
- PRIMARY KEY (id)
- INDEX idx_user_id (user_id)
- INDEX idx_updated_at (updated_at)
- FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE

**外键关系**:
- `user_id` → `users.id` (级联删除)

**当前记录数**: 1

---

### 2.3 messages（消息表）

**用途**: 存储对话中的具体消息内容，包括用户消息和AI回复

| 字段名 | 类型 | 允许NULL | 键 | 默认值 | 说明 |
|--------|------|----------|-----|--------|------|
| id | INT | NO | PRI, AUTO_INCREMENT | NULL | 消息ID（主键） |
| conversation_id | INT | NO | MUL, FK | NULL | 对话ID（外键关联conversations.id） |
| role | ENUM('user','assistant') | NO | - | NULL | 消息角色（用户/AI助手） |
| content | TEXT | NO | - | NULL | 消息内容 |
| created_at | TIMESTAMP | YES | MUL | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY (id)
- INDEX idx_conversation_id (conversation_id)
- INDEX idx_created_at (created_at)
- FOREIGN KEY (conversation_id) REFERENCES conversations(id) ON DELETE CASCADE

**外键关系**:
- `conversation_id` → `conversations.id` (级联删除)

**当前记录数**: 8
- 用户消息: 4
- AI消息: 4

---

### 2.4 speakers（说话人表）

**用途**: 存储用户的语音克隆说话人信息，支持TTS个性化语音

| 字段名 | 类型 | 允许NULL | 键 | 默认值 | 说明 |
|--------|------|----------|-----|--------|------|
| id | INT | NO | PRI, AUTO_INCREMENT | NULL | 说话人ID（主键） |
| user_id | INT | NO | MUL, FK | NULL | 用户ID（外键关联users.id） |
| name | VARCHAR(100) | NO | - | NULL | 说话人名称 |
| spk_id | VARCHAR(100) | NO | UNI | NULL | 说话人唯一标识符 |
| prompt_text | TEXT | YES | - | NULL | 提示文本（用于语音克隆） |
| is_active | BOOLEAN | YES | - | FALSE | 是否为当前激活的说话人 |
| created_at | TIMESTAMP | YES | - | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY (id)
- UNIQUE KEY unique_user_spk (user_id, spk_id)
- INDEX idx_user_id (user_id)
- INDEX idx_user_active (user_id, is_active)
- FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE

**外键关系**:
- `user_id` → `users.id` (级联删除)

**限制**:
- 每个用户最多只能添加 3 个说话人
- (user_id, spk_id) 组合必须唯一

**当前记录数**: 0

---

### 2.5 user_settings（用户设置表）

**用途**: 存储用户的当前设置，如当前使用的说话人

| 字段名 | 类型 | 允许NULL | 键 | 默认值 | 说明 |
|--------|------|----------|-----|--------|------|
| user_id | INT | NO | PRI, FK | NULL | 用户ID（主键，外键关联users.id） |
| current_speaker_id | INT | YES | MUL, FK | NULL | 当前使用的说话人ID（外键关联speakers.id） |

**索引**:
- PRIMARY KEY (user_id)
- INDEX (current_speaker_id)
- FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
- FOREIGN KEY (current_speaker_id) REFERENCES speakers(id) ON DELETE SET NULL

**外键关系**:
- `user_id` → `users.id` (级联删除)
- `current_speaker_id` → `speakers.id` (删除时设为NULL)

**当前记录数**: 0

---

## 三、数据库关系图

```
users (用户表)
  ├── id (主键)
  │
  ├── conversations (对话会话)
  │   ├── user_id → users.id (外键, 级联删除)
  │   └── messages (消息)
  │       └── conversation_id → conversations.id (外键, 级联删除)
  │
  ├── speakers (说话人)
  │   ├── user_id → users.id (外键, 级联删除)
  │   └── id
  │
  └── user_settings (用户设置)
      ├── user_id → users.id (外键, 级联删除)
      └── current_speaker_id → speakers.id (外键, 删除时设为NULL)
```

---

## 四、数据统计汇总

### 4.1 当前数据量

| 表名 | 记录数 | 说明 |
|------|--------|------|
| users | 2 | 注册用户数 |
| conversations | 1 | 对话会话数 |
| messages | 8 | 消息总数 |
| ├── role='user' | 4 | 用户消息数 |
| └── role='assistant' | 4 | AI回复消息数 |
| speakers | 0 | 说话人数量 |
| user_settings | 0 | 用户设置数 |

### 4.2 数据增长趋势

- **用户注册**: 当前有 2 个注册用户
- **对话活跃度**: 有 1 个对话会话，包含 8 条消息
- **语音功能**: 尚未有用户添加说话人

---

## 五、数据库特性

### 5.1 存储引擎

所有表均使用 **InnoDB** 存储引擎：
- 支持事务（ACID）
- 支持外键约束
- 支持行级锁定
- 更好的并发性能

### 5.2 字符集

- **数据库字符集**: utf8mb4
- **排序规则**: utf8mb4_unicode_ci
- **优势**: 支持完整的 Unicode 字符集，包括 emoji 表情符号

### 5.3 级联删除策略

为了数据一致性，系统采用级联删除：

1. **删除用户** → 自动删除该用户的所有对话、消息、说话人和设置
2. **删除对话** → 自动删除该对话的所有消息
3. **删除说话人** → 用户设置中的 `current_speaker_id` 自动设为 NULL

---

## 六、数据库初始化

### 6.1 初始化方式

项目在启动时（`app.py` 的 `init_db()` 函数）会自动初始化数据库：

1. 创建数据库（如果不存在）
2. 创建所有表（如果不存在）
3. 创建索引和外键约束

### 6.2 手动初始化

也可以使用独立的初始化脚本：

```bash
cd backend
python init_database.py
```

### 6.3 初始化代码位置

- **主初始化函数**: `backend/app.py` 中的 `init_db()` 函数（第215-310行）
- **独立初始化脚本**: `backend/init_database.py`

---

## 七、数据库操作示例

### 7.1 连接数据库

```python
from config import MYSQL_HOST, MYSQL_PORT, MYSQL_USER, MYSQL_PASSWORD, MYSQL_DATABASE, MYSQL_CHARSET
import pymysql

conn = pymysql.connect(
    host=MYSQL_HOST,
    port=MYSQL_PORT,
    user=MYSQL_USER,
    password=MYSQL_PASSWORD,
    database=MYSQL_DATABASE,
    charset=MYSQL_CHARSET,
    cursorclass=pymysql.cursors.DictCursor
)
```

### 7.2 常用查询

- **获取用户的所有对话**:
  ```sql
  SELECT * FROM conversations WHERE user_id = ? ORDER BY updated_at DESC
  ```

- **获取对话的所有消息**:
  ```sql
  SELECT * FROM messages WHERE conversation_id = ? ORDER BY created_at ASC
  ```

- **获取用户的说话人列表**:
  ```sql
  SELECT * FROM speakers WHERE user_id = ? ORDER BY is_active DESC, created_at DESC
  ```

---

## 八、备份与维护建议

### 8.1 定期备份

建议定期备份数据库：

```bash
mysqldump -u root -p magicmirror > backup_$(date +%Y%m%d).sql
```

### 8.2 性能优化

- 已为常用查询字段创建索引
- 建议定期检查慢查询日志
- 对于大量数据，考虑分区表

### 8.3 安全建议

- 使用强密码保护数据库
- 限制数据库用户权限（最小权限原则）
- 定期更新 MySQL 版本

---

## 九、版本信息

- **文档生成日期**: 2024年
- **数据库版本**: MySQL
- **Python驱动**: pymysql
- **字符集**: utf8mb4

---

## 十、联系方式

如有数据库相关问题，请参考：
- 项目代码: `backend/app.py`
- 配置文件: `backend/config.py`
- 初始化脚本: `backend/init_database.py`

